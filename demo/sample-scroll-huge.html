<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
	<title>Fancytree - Example: Scrolling</title>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js" type="text/javascript"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1/jquery-ui.min.js" type="text/javascript"></script>
	<link href="../src/skin-win8/ui.fancytree.css" rel="stylesheet" type="text/css">

	<script src="../src/jquery.fancytree.js" type="text/javascript"></script>
	<script src="../src/jquery.fancytree.columnview.js" type="text/javascript"></script>
	<script src="../src/jquery.fancytree.dnd.js" type="text/javascript"></script>
	<script src="../src/jquery.fancytree.table.js" type="text/javascript"></script>

	<!-- Start_Exclude: This block is not part of the sample code -->
	<link href="../lib/prettify.css" rel="stylesheet">
	<script src="../lib/prettify.js" type="text/javascript"></script>
	<link href="sample.css" rel="stylesheet" type="text/css">
	<script src="sample.js" type="text/javascript"></script>
	<!-- End_Exclude -->
<style type="text/css">
ul.fancytree-container {
	width: 600px;
	height: 320px;
	overflow: auto;
	position: relative;
}
</style>
	<!-- Add code to initialize the tree when the document is loaded: -->
<script type="text/javascript">
// http://lions-mark.com/jquery/scrollTo/

/*
$.fn.scrollTo = function( target, options, callback ){
	if(typeof options == 'function' && arguments.length == 2){ callback = options; options = target; }
	var settings = $.extend({
		scrollTarget: target,
		offsetTop: 0, //50,
		duration: 500,
		easing: "swing"
	}, options);
	return this.each(function(){
	  var scrollPane = $(this);
	  var scrollTarget = (typeof settings.scrollTarget == "number") ? settings.scrollTarget : $(settings.scrollTarget);
	  var scrollY = (typeof scrollTarget == "number") ? scrollTarget : scrollTarget.offset().top + scrollPane.scrollTop() - parseInt(settings.offsetTop);
	  scrollPane.animate({scrollTop : scrollY }, parseInt(settings.duration), settings.easing, function(){
		  if (typeof callback == 'function') { callback.call(this); }
	  });
	});
  }
  */

	var setExpandedOptions = {noAnimation: true};
	// setExpandedOptions = false; // full animation slows expansion/collapse down significantly

	function safeSetExpanded(node, expand, promises, opts) {
		var isExpanded = node.isExpanded();
		if ((expand && !isExpanded) || (!expand && isExpanded)) {
			// avoid warnings, which distort benchmark
			var promise = node.setExpanded(expand, opts);
			if (promise) {
				if (promise.state() != 'rejected') {
					promises.push(promise);
				}
			}
			return promise;
		}
	}

	// makeOptions([options,] func, func_name, _options)
	function makeOptions(options, func, func_name, _options) {
		if (typeof(options) == 'undefined') {
			options = {};
		} else if (typeof(options) == 'function') {
			func = options;
			options = false;
		}
		if (typeof(func_name) == 'undefined') {
			func_name = 'func';
		}
		if (typeof(_options) == 'undefined') {
			_options = {};
		}
		$.extend(_options, options);
		if (func) {
			_options[func_name] = func;
		}
		return _options;
	}

	// showNode(node[, options], complete)
	function showNode(node, options, complete) {
		options = makeOptions(options, complete, 'complete', {
			makeVisible: true,
			centered: false,
			complete: null,
			fx: {duration: 200, queue: false}
		});
		complete = options.complete;
		var opts = node.tree.options;
		var complete_done = false;
		var activeSpan = node.span;
		if (options.makeVisible) {
			node.makeVisible({noAnimation: !!activeSpan});
		}
		if (activeSpan) {
			var $container = opts.scrollContainer ? opts.scrollContainer : node.tree.$container;
			if ($container.length) {
				var cheight = $container.height();
				var parent = node.parent.span;
				var ptop = parent && $(parent).offset().top;
				var atop = $(activeSpan).offset().top;

				var peligible = false;
				var scrollSpan;
				var context = 0;
				if (!options.centered && parent && node.parent.parent && (atop - ptop) < cheight) {
					scrollSpan = parent;
					peligible = true;
				} else {
					scrollSpan = activeSpan;
					if (options.centered || node.parent.parent) {
						context = -(cheight/2);
					};
				}
				var scrollTop = $(scrollSpan).offset().top - $container.offset().top + $container.scrollTop() + context;
				var fx = options.fx;
				if (fx && complete) {
					fx = $.extend({complete: complete}, fx);
				}
				$container.animate({scrollTop: scrollTop}, fx, complete);
				complete_done = true;
			}
		}
		if (complete && !complete_done) {
			complete();
		}
	}

	function expandCollapseNode(node, expand, options, complete) {
		var type = (expand ? 'expansion' : 'collapse');
		var promises = [];
		options = makeOptions(options, complete, 'complete');

		//if (node.parent && expand) {
		//	safeSetExpanded(node, false, promises, setExpandedOptions);
		//}
		node.visit(function(node){
			safeSetExpanded(node, expand, promises, setExpandedOptions);
		});
		if (node.parent && expand) {
			safeSetExpanded(node, expand, promises, setExpandedOptions);
		}

		function finalize () {
			var $container = node.tree.$container;

			// Determine active node
			var activeNode = node.tree.getActiveNode();
			if (!activeNode) {
				activeNode = node.tree.getFocusNode();
			}
			if (!activeNode) {
				if (!node.parent) {
					activeNode = node.getFirstChild();
				} else {
					activeNode = node;
				}
			}
			if (activeNode) {
				showNode(activeNode, options);
			} else {
				complete = options.complete;
				if (complete) {
					complete();
				}
			}
		}
		return $.when.apply(null, promises).then(finalize, finalize);
	}

	$(function(){
			<!-- Start_Exclude: This block is not part of the sample code -->
			$.ui.fancytree.debugLevel = 0;
		console.log('$.ui.fancytree.debugLevel:', $.ui.fancytree.debugLevel);
			<!-- End_Exclude -->

		// Attach the fancytree widget to an existing <div id="tree"> element
		// and pass the tree options as an argument to the fancytree() function:
		$("#tree").fancytree({
			extensions: [],
			checkbox: true,
			autoScroll: true,
			debugLevel: 0,
			tabbable: true,
			source: {
				url: "../test/unit/ajax-tree-huge-scroll.json"
			},
			lazyload: function(event, data) {
				data.result = {url: "../test/unit/ajax-sub2.json"}
			},
			init: function(event, data) {
				data.tree.getFirstChild().setFocus();
				data.tree.activateKey('10.3.3');
				// cycle once to build tree, which would bias statistics
				var svSetExpandedOptions = setExpandedOptions;
				setExpandedOptions	= {noAnimation: true};
				expandCollapseNode(data.tree.rootNode, true, {fx: false}, function() {
					expandCollapseNode(data.tree.rootNode, false, function() {
						setExpandedOptions = svSetExpandedOptions;
					});
				});
			},
		});

		<!-- Start_Exclude: This block is not part of the sample code -->
		<!-- End_Exclude -->
	});

</script>

<!-- Start_Exclude: This block is not part of the sample code -->
<script>
$(function(){
	addSampleButton({
		label: "Expand all",
		newline: false,
		code: function(){
			expandCollapseNode($('#tree').fancytree('getRootNode'), true);
		}
	});
	addSampleButton({
	label: "Collapse all",
		newline: false,
		code: function(){
			expandCollapseNode($('#tree').fancytree('getRootNode'), false);
		}
	});
	addSampleButton({
		label: "Cycle",
		newline: true,
		code: function(){
			expandCollapseNode($('#tree').fancytree('getRootNode'), true, {fx: false}, function () {
			    expandCollapseNode($('#tree').fancytree('getRootNode'), false);
			});
		}
	});
	addSampleButton({
		label: "Expand subtree",
		newline: false,
		code: function(){
			var tree = $('#tree').fancytree('getTree');
			if (tree) {
				var activeNode = tree.getActiveNode();
				if (!activeNode) {
					activeNode = tree.getFocusNode();
				}
				if (activeNode) {
					expandCollapseNode(activeNode, true);
				}
			}
		}
	});
	addSampleButton({
	label: "Collapse subtree",
		newline: false,
		code: function(){
			var tree = $('#tree').fancytree('getTree');
			if (tree) {
				var activeNode = tree.getActiveNode();
				if (!activeNode) {
					activeNode = tree.getFocusNode();
				}
				if (activeNode) {
					expandCollapseNode(activeNode, false);
				}
			}
		}
	});
	addSampleButton({
		label: "Cycle",
		newline: true,
		code: function(){
			var tree = $('#tree').fancytree('getTree');
			if (tree) {
				var activeNode = tree.getActiveNode();
				if (!activeNode) {
					activeNode = tree.getFocusNode();
				}
				if (activeNode) {
					expandCollapseNode(activeNode, true, {fx: false}, function () {
						expandCollapseNode(activeNode, false);
					});
				}
			}
		}
	});
});
</script>
<!-- End_Exclude -->

</head>
<body class="example">
	<h1>Example: scrolling</h1>
	<p class="description">
	</p>
	<div>
		<label for="skinswitcher">Skin:</label> <select id="skinswitcher"></select>
	</div>
	<!-- Add a <table> element where the tree should appear: -->
	<p class="description">
		Standard tree:
	</p>
	<div id="tree"></div>

	<!-- Add a <table> element where the tree should appear: -->
	<p class="description">
		Table tree:
	</p>
	<!-- Start_Exclude: This block is not part of the sample code -->
	<p id="sampleButtons">
	</p>
	<hr>
	<p class="sample-links  no_code">
		<a class="hideInsideFS" href="https://github.com/mar10/fancytree">jquery.fancytree.js project home</a>
		<a class="hideOutsideFS" href="#">Link to this page</a>
		<a class="hideInsideFS" href="index.html">Example Browser</a>
		<a href="#" id="codeExample">View source code</a>
	</p>
	<pre id="sourceCode" class="prettyprint" style="display:none"></pre>
	<!-- End_Exclude -->
</body>
</html>
